name: CI Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  AWS_REGION: us-east-2
  AWS_ROLE_ARN: arn:aws:iam::143519759870:role/GitHubActionsMLOpsRole
  AWS_ACCOUNT_ID: "143519759870"

jobs:
  validate-and-build:
    runs-on: ubuntu-latest

    permissions:
      id-token: write # Required for OIDC authentication
      contents: read # Required to checkout code

    steps:
      # Step 1: Checkout repository
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: Set up Python
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # Step 3: Install Python dependencies for testing
      - name: Install test dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      # Step 4: Validate services configuration
      # This checks if all service directories exist and have required files
      - name: Validate project structure
        run: |
          echo "Validating microservices structure..."
          for service in inference-service feedback-service model-registry-service evaluation-service retraining-service notification-service model-init-service api-gateway-service; do
            if [ ! -d "services/$service" ]; then
              echo "ERROR: Missing service directory: $service"
              exit 1
            fi
            if [ ! -f "services/$service/Dockerfile" ]; then
              echo "ERROR: Missing Dockerfile for: $service"
              exit 1
            fi
            if [ ! -f "services/$service/requirements.txt" ]; then
              echo "ERROR: Missing requirements.txt for: $service"
              exit 1
            fi
            echo "✓ $service validated"
          done
          echo "All services validated successfully!"

      # Step 5: Validate Docker Compose configuration
      - name: Validate docker-compose.yml
        run: |
          echo "Validating docker-compose configuration..."
          docker compose config > /dev/null
          echo "✓ docker-compose.yml is valid"

      # Step 6: Build all Docker images
      # This ensures all services can be containerized successfully
      - name: Build Docker images
        run: |
          echo "Building all microservices..."
          docker compose build
          echo "✓ All Docker images built successfully"

      # Step 7: List built images for verification
      - name: List Docker images
        run: |
          echo "Built images:"
          docker images | grep -E "(ml-sentiment|inference|feedback|registry|evaluation|retraining|notification|init|gateway)"

      # Step 8: Configure AWS credentials using OIDC
      # This uses GitHub's OIDC provider to assume an IAM role
      # No static credentials needed!
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-CI-${{ github.run_id }}

      # Step 9: Verify AWS authentication
      # Confirms that OIDC authentication was successful
      - name: Verify AWS identity
        run: |
          echo "Verifying AWS credentials..."
          aws sts get-caller-identity
          echo "✓ AWS authentication successful"

      # Step 10: Run basic AWS connectivity tests
      # Ensures the assumed role has necessary permissions
      - name: Test AWS permissions
        run: |
          echo "Testing AWS S3 access..."
          aws s3 ls || echo "⚠ S3 access not configured (expected for initial setup)"

          echo "Testing AWS SageMaker access..."
          aws sagemaker list-training-jobs --max-results 1 || echo "⚠ SageMaker access not configured (expected for initial setup)"

          echo "Testing AWS ECR access..."
          aws ecr describe-repositories || echo "⚠ ECR access not configured (expected for initial setup)"

      # Step 11: Clean up Docker resources
      - name: Clean up
        if: always()
        run: |
          echo "Cleaning up Docker resources..."
          docker compose down --volumes --remove-orphans || true
          docker system prune -f || true

  # CD Job: Push images to ECR (runs only on main branch push)
  push-to-ecr:
    runs-on: ubuntu-latest
    needs: validate-and-build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-CD-${{ github.run_id }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Create ECR repositories if not exist
        run: |
          for service in inference-service feedback-service model-registry-service evaluation-service retraining-service notification-service model-init-service api-gateway-service; do
            aws ecr describe-repositories --repository-names ml-sentiment-$service 2>/dev/null || \
            aws ecr create-repository --repository-name ml-sentiment-$service --image-scanning-configuration scanOnPush=true
            echo "✓ Repository ml-sentiment-$service ready"
          done

      - name: Build and push Docker images to ECR
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          echo "Building and pushing images with tag: $IMAGE_TAG"

          # Build and push each service
          for service in inference-service feedback-service model-registry-service evaluation-service retraining-service notification-service model-init-service api-gateway-service; do
            echo "Processing $service..."
            
            # Build image
            docker build -t ml-sentiment-$service:latest ./services/$service
            
            # Tag for ECR
            docker tag ml-sentiment-$service:latest $ECR_REGISTRY/ml-sentiment-$service:$IMAGE_TAG
            docker tag ml-sentiment-$service:latest $ECR_REGISTRY/ml-sentiment-$service:latest
            
            # Push to ECR
            docker push $ECR_REGISTRY/ml-sentiment-$service:$IMAGE_TAG
            docker push $ECR_REGISTRY/ml-sentiment-$service:latest
            
            echo "✓ $service pushed to ECR"
          done

          echo "All images pushed successfully!"

      - name: Output image URIs
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          echo "Images pushed to ECR:"
          echo "----------------------------------------"
          for service in inference-service feedback-service model-registry-service evaluation-service retraining-service notification-service model-init-service api-gateway-service; do
            echo "$service: $ECR_REGISTRY/ml-sentiment-$service:$IMAGE_TAG"
          done

  # Future job: deploy-to-ecs (will be added after ECS infrastructure is set up)
  # This will:
  # - Update ECS task definitions with new image URIs
  # - Deploy to ECS services
  # - Run health checks
  # 
  # Pipeline status: ECR deployment active, ECS/S3/SageMaker pending
